\chapter{Calculo lambda tipado con subtipos}

En la secci\'on anterior definimos la sint\'axis y sem\'antica del lenguaje que llamamos
$\lambdaarrow$, para esto en el transcurso introducimos distintos conceptos sobre el tipado.
Ahora vamos estudiar a $\lambdaleq$, el cual tiene como fin introducir conceptos sobre
el subtipado, por esta raz\'on el lenguaje se mantiene exactamente igual al lenguaje 
de la secci\'on anterior. La principal diferencia entonces estar\'a en la definici\'on
de la categor\'ia de tipos y en que vamos a agregar un nuevo juicio de tipado, como
consecuencia de esto ultimo, tendremos que agregar nuevas reglas de tipado y ecuaciones 
sem\'anticas.\\

Entre los tipos del lenguaje $\lambdaarrow$, y por lo tanto los de $\lambdaleq$, tenemos
a $\intt$ y $\realt$ los cuales representan los conjuntos de enteros y reales matem\'aticos.
Algo interesante a pensar es que, los enteros forman parte de los reales, es decir,
$\Z \subseteq \R$, luego surge la pregunta, ¿Existir\'a una forma de expresar esta relaci\'on 
como una relaci\'on entre los $\lrangles{Type}$?, la respuesta es s\'i y es el subtipado.\\

Comencemos introduciendo el nuevo juicio de tipado, este sera una relaci\'on entre tipos,
sean $\theta$ y $\theta'$ diremos que $\theta$ es subtipo de $\theta'$ cuando $\theta \leq \theta'$.

Primero veamos reglas de inferencia generales a cualquier tipo, empecemos discutiendo
una idea intuitiva de las reglas que ser\'ian deseables. Supongamos tenemos que la expresi\'on
$e$ tiene tipo $\intt$ y adem\'as que $\intt$ es subtipo de $\realt$, luego quisi\'eramos 
poder decir que $e$ tiene tipo $\realt$, adem\'as si suponemos un tipo $nat$ que es
subtipo de $int$, entonces deber\'iamos poder decir que $nat$ es subtipo de $\realt$,
es decir, tener transitividad entre los tipos, cualquier tipo es
subtipo de \'el mismo, es decir, los tipos son reflexivos. Para finalizar, 
supongamos tenemos $\theta_0 \leq \theta_0'$ y $\theta_1 \leq \theta_1'$ y adem\'as
que tenemos una expresi\'on $e$ que tiene tipo $\theta_0' \rightarrow \theta_1$. Luego
$e$ puede aplicarse a elementos de tipo $\theta_0$ y el resultado de tal aplicaci\'on
puede ser un elemento de tipo $\theta_1'$.\\

\noindent
$\texttt{Ty Rule:}$ Subsumption.

\begin{center}
\AxiomC{$\pi \vdash e : \theta$}
\AxiomC{$\theta \leq \theta'$}
\BinaryInfC{$\pi \vdash e : \theta'$}
\DisplayProof
\end{center}

\

\noindent
$\texttt{Ty Rule:}$ Trans.

\begin{center}
\AxiomC{$\theta \leq \theta'$}
\AxiomC{$\theta' \leq \theta''$}
\BinaryInfC{$\theta \leq \theta''$}
\DisplayProof
\end{center}

\

\

\

\noindent
$\texttt{Ty Rule:}$ Reflex.

\begin{center}
\AxiomC{}
\UnaryInfC{$\theta \leq \theta$}
\DisplayProof
\end{center}

\

\noindent
$\texttt{Ty Rule:}$ Func.

\begin{center}
\AxiomC{$\theta_0 \leq \theta_0'$}
\AxiomC{$\theta_1 \leq \theta_1'$}
\BinaryInfC{$\theta_0' \rightarrow \theta_1 \leq \theta_0 \rightarrow \theta_1'$}
\DisplayProof
\end{center}

Estas reglas que mencionamos tiene la particularidad de ser generales para
cualquier sistema de tipado, definamos ahora mas reglas en relaci\'on a nuestros
tipos y lenguaje concreto, esto ser\'a definir la relaci\'on entre enteros y reales
y vamos a agregar una mas, tal vez no sea lo mas recomendado en cuanto al diseño
del lenguaje pero es practico considerarla, que es la relaci\'on entre booleanos
y enteros.

\

\noindent
$\texttt{Ty Rule:}$ boolToint.

\begin{center}
\AxiomC{}
\UnaryInfC{$\boolt \leq \intt$}
\DisplayProof
\end{center}

\noindent
$\texttt{Ty Rule:}$ intToreal.

\begin{center}
\AxiomC{}
\UnaryInfC{$\intt \leq \realt$}
\DisplayProof
\end{center}

\section{Sem\'antica para $\lambdaleq$}

Ahora que tenemos definido el nuevo juicio de tipado y la relaci\'on entre los 
tipos, vamos a actualizar nuestra categor\'ia de tipos, esta dejara de ser
una categor\'ia discreta y la clave esta en que ahora nuestra relaci\'on entre
los tipos determinara las flechas.

\begin{definition}\label{lambdal:typescategory}
La categor\'ia de tipos, que nombraremos $\Theta$, se define como sigue\\

$\Theta_0$ $=$ $\{\theta \ | \ \theta \ \in \lrangles{Type} \}$\\
\indent
$\Theta_1(\theta,\theta')$ $=$ $\{\theta \rTo \theta' \ | \ \theta \leq \theta'\}$

\end{definition}

Esta nueva categor\'ia coincide con el pre-orden de tipos con la relaci\'on de orden
$\leq$ visto como categor\'ia, por lo tanto se desprende que dados
dos tipos $\theta$ y $\theta'$, $| \ \Theta_1(\theta,\theta') \ | \leq \ 1$.

Adem\'as esta nueva definici\'on nos impacta directamente en el
funtor sem\'antico $\semBrcks{ \ } : \Theta \rightarrow \CD$, ahora tenemos que 
definir como act\'ua el funtor con respecto a las flechas.

\begin{definition}\label{lambdal:typesemfunctor}
Sea $\semBrcks{ \ } : \Theta \rightarrow \CD$ un funtor, tal que\\

$\semBrcks{\delta}_0$ $=$ $(S_\delta)_\bot$\\
\indent
$\semBrcks{\theta \rightarrow \theta'}_0$ $=$ $\semBrcks{\theta'}_0^{\semBrcks{\theta}_0}$\\

\[
\semBrcks{\boolt \leq \intt}_1 \ x =
\begin{cases}
0  & \text{si } \text{x} \\
1  & \text{si } \neg \text{x}
\end{cases}
\]
\indent
$\semBrcks{\intt \leq \realt}_1$ $=$ $\J$\\
\indent
$\semBrcks{\theta \leq \theta}_1$ $=$ $1_{\semBrcks{\theta}}$\\
\indent
$\semBrcks{\theta \leq \theta''}_1$ $=$ $\semBrcks{\theta' \leq \theta''}_1 \circ \semBrcks{\theta \leq \theta'}_1$\\
\indent
$\semBrcks{(\theta_0 \rightarrow \theta'_0) \leq (\theta_1 \rightarrow \theta'_1)}_1$ 
				$=$ 
				$\lambda f \in \semBrcks{\theta_0 \rightarrow \theta'_0}_0$ .
				$\semBrcks{\theta'_0 \leq \theta'_1}_1 \circ f \circ \semBrcks{\theta_1 \leq \theta_0}_1$\\

con $\J$ la inyecci\'on de enteros en reales.

\end{definition}

Antes de seguir con la nueva definici\'on de la categor\'ia de contextos analicemos 
la definici\'on $\semBrcks{(\theta_0 \rightarrow \theta'_0) \leq (\theta_1 \rightarrow \theta'_1)}$.
La idea ser\'a ver que la definici\'on que dimos es correcta y adem\'as mostrar de que manera
la podemos construir, comencemos notando que,\\

$\semBrcks{\theta_1 \leq \theta_0} : \semBrcks{\theta_1} \rightarrow \semBrcks{\theta_0} 
= Hom_{\Dom}(\semBrcks{\theta_1},\semBrcks{\theta_0})$\\

$\semBrcks{\theta_0' \leq \theta_1'} : \semBrcks{\theta_0'} \rightarrow \semBrcks{\theta_1'}
= Hom_{\Dom}(\semBrcks{\theta_0'},\semBrcks{\theta_1'})$\\

y definamos entonces dos funtores, uno covariante $Hom(\semBrcks{\theta_1}, \_ )$ y otro contravariante
$Hom(\_,\semBrcks{\theta_1'})$. \\

Tomemos una funci\'on $f$ en $\semBrcks{\theta_0 \rightarrow \theta_0'}$ cualquiera, luego \\

$Hom(\semBrcks{\theta_1}, f)$ $:$ 
$Hom(\semBrcks{\theta_1}, \semBrcks{\theta_0}) \rightarrow Hom(\semBrcks{\theta_1}, \semBrcks{\theta_0'})$,\\

usando lo que notamos al principio podemos hacer, es decir, $\semBrcks{\theta_1 \leq \theta_0} : Hom_{\Dom}(\semBrcks{\theta_1},\semBrcks{\theta_0})$, obtenemos \\

$Hom(\semBrcks{\theta_1}, f) \semBrcks{\theta_1 \leq \theta_0}$ $=$ $f \circ \semBrcks{\theta_1 \leq \theta_0} : 
Hom(\semBrcks{\theta_1}, \semBrcks{\theta_0'})$.\\

Si ahora hacemos algo similar usando el otro funtor tenemos,\\

$Hom(f \circ \semBrcks{\theta_1 \leq \theta_0}, \semBrcks{\theta_1'})$ $:$ 
$Hom(\semBrcks{\theta_0'}, \semBrcks{\theta_1'}) \rightarrow Hom(\semBrcks{\theta_1}, \semBrcks{\theta_1'})$,\\

y aplicando el funtor como antes podemos llegar a la ecuación propuesta,\\

$Hom(f \circ \semBrcks{\theta_1 \leq \theta_0}, \semBrcks{\theta_1'})\semBrcks{\theta_0' \leq \theta_1'}$ $=$
$\semBrcks{\theta_0' \leq \theta_1'} \circ f \circ \semBrcks{\theta_1 \leq \theta_0}$.\\

Luego podemos mencionar que el subtipado para un tipo $\theta \rightarrow \theta'$ es covariante
para $\theta$ y contravariante para $\theta'$.\\

La definici\'on de la relaci\'on $\leq$ entre tipos nos permite ademas actualizar 
la definici\'on de la categor\'ia de contexto, de manera tal de definir $\leq$ entre
contextos para que luego, como pasa con los tipos, esta relaci\'on sea una flecha 
en la categor\'ia. Dados $\pi$ y $\pi'$ tal que $dom \ \pi$ $=$ $dom \ \pi'$, diremos
que $\pi \leq \pi'$ cuando para todo $\iota \in dom \ \pi$ se cumple $\pi \iota \leq \pi' \iota$.\\

\begin{definition}\label{lambdal:contextcategory}
La categor\'ia de contextos, que nombraremos $\Pi$, se define como sigue\\

$\Pi_0$ $=$ $\{\pi \ | \ \pi \ \in \lrangles{Context} \}$\\
\indent
$\Pi_1(\pi,\pi')$ $=$ $\{ \pi \rTo \pi' \ | \ \pi \leq \pi' \}$

\end{definition}

De igual manera que cuando dimos la nueva definici\'on de $\Theta$, podemos dar
una actualizaci\'on a la definici\'on de $\Pi$.

\begin{definition}\label{lambdal:contextsemfunctor}
Sea $\semBrcks{ \ } : \Pi \rightarrow \CD$ un funtor, tal que\\

$\semBrcks{\pi}_0$ $=$ $\prod\limits_{\iota \in dom \ \pi} \semBrcks{\pi\iota}$\\
\indent
$\semBrcks{\pi \leq \pi'}_1$ $=$ $\prod\limits_{\iota \in dom \ \pi} \semBrcks{\pi\iota \leq \pi'\iota}$

\end{definition}

Esta ultima definici\'on da por terminado el trabajo de acomodar los
dominios categoricos, ademas de las nuevos jucios de tipado y su 
sem\'antica respectiva.

Para completar la sem\'antica del lenguaje lambda leq, nos falta 
definir una ecuaci\'on sem\'antica que relacione un juicio de tipado
con una relaci\'on de orden entre dos tipos, la ecuaci\'on que estamos
buscando relaci\'on con la regla de inferencia Subsumption.\\
\

\noindent
$\texttt{Denotal Sem:}$ Subsumption.\

\

$\semBrcks{\pi \vdash e : \theta'}$ $=$ $\semBrcks{\theta \leq \theta'} \circ \semBrcks{\pi \vdash e : \theta}$

\section{Continuidad de las ecuaciones sem\'anticas de $\lambdaleq$}

Al igual que como hicimos para el lenguaje $\lambdaarrow$ vamos a probar la
continuidad de las ecuaciones sem\'anticas de $\lambdaleq$. En cuanto a 
esta prueba lo interesante es que es realmente simple, ya que usando la 
prueba de continuidad de $\lambdaarrow$ simplemente nos resta probar 
la continuidad de Subsumption.

\begin{theorem}

Dado un juicio de tipado $\pi \vdash e : \theta$ la ecuaci\'on sem\'antica
\\ 
$\semBrcks{\pi \vdash e : \theta}$ es una funci\'on continua.

\end{theorem}

\begin{proof}

En la prueba vamos a proceder por inducci\'on es la estructura de la derivaci\'on 
de los juicios de tipado. Adem\'as como ya mencionamos antes, solamente nos resta
probar el caso inductivo para la sem\'antica denotacional de subsumption, supongamos
entonces un juicio de tipado $\pi \vdash e : \theta'$, luego\\

$\semBrcks{\pi \vdash e : \theta'}$ $=$ $\semBrcks{\theta \leq \theta'} \circ \semBrcks{\pi \vdash e : \theta}$\\

por hip\'otesis inductiva obtenemos $\semBrcks{\pi \vdash e : \theta}$ es una funci\'on
continua, adem\'as por construcci\'on de nuestra categ\'oria de tipos
tenemos que $\semBrcks{\theta \leq \theta'}$ es una funci\'on continua tambi\'en, 
por lo tanto utilizando que la composici\'on de funciones continuas es una funci\'on
continua concluimos que $\semBrcks{\pi \vdash e : \theta'}$ es funci\'on continua y
damos por completada la prueba de continuidad para las ecuaciones sem\'anticas
de $\lambdaleq$.

\end{proof}
